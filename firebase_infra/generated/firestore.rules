rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // BEGIN swimify

    // ==============================================================
    // Helper Functions
    // ==============================================================

    function isLoggedIn() {
      return request.auth != null;
    }

    function isClubCreator(clubId) {
      return request.auth != null
        && get(/databases/$(database)/documents/swimClubs/$(clubId))
          .data.creatorId == request.auth.uid;
    }


    function isCoach(clubId) {
      return request.auth != null && (
        exists(
          /databases/$(database)/documents/swimClubs/$(clubId)/coaches/$(request.auth.uid)
        )
        || get(
          /databases/$(database)/documents/swimClubs/$(clubId)
        ).data.creatorId == request.auth.uid
      );
    }

    // Fallback for newly invited coaches before the coaches/{uid} membership
    // doc is present in the club subcollection.
    function isCoachByUserProfile(clubId) {
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      let role = profile.role;
      let userType = profile.userType;
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && profile.clubId == clubId
        && (
          userType == 'coach'
          || userType == 'Coach'
          || userType == 'COACH'
          || role == 'coach'
          || role == 'Coach'
          || role == 'COACH'
        );
    }

    function isClubAdminByUserProfile(clubId) {
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      let role = profile.role;
      let userType = profile.userType;
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && profile.clubId == clubId
        && (
          userType == 'clubadmin'
          || userType == 'ClubAdmin'
          || userType == 'CLUBADMIN'
          || userType == 'admin'
          || userType == 'Admin'
          || userType == 'ADMIN'
          || role == 'clubadmin'
          || role == 'ClubAdmin'
          || role == 'CLUBADMIN'
          || role == 'admin'
          || role == 'Admin'
          || role == 'ADMIN'
        );
    }

    function matchesUserIdentity(idValue) {
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return request.auth != null
        && idValue is string
        && (
          idValue == request.auth.uid
          || (profile.uid is string && idValue == profile.uid)
          || (profile.id is string && idValue == profile.id)
        );
    }

    function isClubMember(clubId) {
      return isCoach(clubId) ||
        exists(
          /databases/$(database)/documents/swimClubs/$(clubId)/admins/$(request.auth.uid)
        ) ||
        isClubAdminByUserProfile(clubId) ||
        isCoachByUserProfile(clubId);
    }

    function userClubId() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.clubId
        : null;
    }

    function isCoachInOwnClub() {
      return request.auth != null
        && userClubId() != null
        && isCoach(userClubId());
    }

    function isSessionInCoachClub(sessionId) {
      return request.auth != null
        && userClubId() != null
        && exists(
          /databases/$(database)/documents/swimClubs/$(userClubId())/sessions/$(sessionId)
        );
    }

    function _sessionDoc(clubId, sessionId) {
      return get(
        /databases/$(database)/documents/swimClubs/$(clubId)/sessions/$(sessionId)
      ).data;
    }

    function isSwimmerAssignedToSession(clubId, sessionId, swimmerId) {
      return request.auth != null
        && exists(
          /databases/$(database)/documents/swimClubs/$(clubId)/sessions/$(sessionId)
        )
        && _sessionDoc(clubId, sessionId).assignedSwimmerIds is list
        && swimmerId in _sessionDoc(clubId, sessionId).assignedSwimmerIds;
    }

    function isSwimmerInCoachClub(swimmerId) {
      return request.auth != null
        && userClubId() != null
        && exists(
          /databases/$(database)/documents/swimClubs/$(userClubId())/swimmers/$(swimmerId)
        );
    }

    function isSwimmerInGroup(groupId) {
      let groupData = get(
        /databases/$(database)/documents/swimGroups/$(groupId)
      ).data;
      return request.auth != null && request.auth.uid in groupData.swimmerIds;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isStaff() {
      return request.auth != null
        && (
          request.auth.token.staff == true
          || request.auth.token.isStaff == true
        );
    }

    function isClubAdmin(clubId) {
      return request.auth != null &&
        exists(
          /databases/$(database)/documents/swimClubs/$(clubId)/admins/$(request.auth.uid)
        );
    }

    function coachAssignedGroupIds(clubId) {
      return request.auth != null
        && exists(/databases/$(database)/documents/swimClubs/$(clubId)/coaches/$(request.auth.uid))
        && get(/databases/$(database)/documents/swimClubs/$(clubId)/coaches/$(request.auth.uid)).data.assignedGroupIds is list
        ? get(/databases/$(database)/documents/swimClubs/$(clubId)/coaches/$(request.auth.uid)).data.assignedGroupIds
        : [];
    }

    function canCoachManageGroup(clubId, groupId, groupCoachId) {
      return request.auth != null
        && (isCoach(clubId) || isCoachByUserProfile(clubId))
        && (
          (groupCoachId is string && matchesUserIdentity(groupCoachId))
          || (groupId is string && groupId in coachAssignedGroupIds(clubId))
        );
    }

    function canManageScheduleGroup(clubId, groupId, groupCoachId) {
      return isClubAdmin(clubId) || canCoachManageGroup(clubId, groupId, groupCoachId);
    }

    function isValidMembershipRole(role) {
      return role == 'swimmer' || role == 'coach' || role == 'admin';
    }

    function isValidMembershipStatus(status) {
      return status == 'active' || status == 'inactive';
    }

    function isV2ClubMemberActive(clubId, uid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/clubs/$(clubId)/members/$(uid))
        && get(/databases/$(database)/documents/clubs/$(clubId)/members/$(uid)).data.status == 'active';
    }

    function v2ClubMemberRole(clubId, uid) {
      return isV2ClubMemberActive(clubId, uid)
        ? get(/databases/$(database)/documents/clubs/$(clubId)/members/$(uid)).data.role
        : null;
    }

    function isV2ClubMember(clubId) {
      return request.auth != null && isV2ClubMemberActive(clubId, request.auth.uid);
    }

    function isV2ClubCoachOrAdmin(clubId) {
      let role = v2ClubMemberRole(clubId, request.auth.uid);
      return role == 'coach' || role == 'admin';
    }

    function isV2ClubAdmin(clubId) {
      return v2ClubMemberRole(clubId, request.auth.uid) == 'admin';
    }

    match /clubSubscriptions/{clubId} {
          // Allows any logged-in user to check if a club is active.
          // This unblocks your app gate logic.
          allow read: if request.auth != null;
        }

    match /clubSapSeats/{clubId} {
      allow get, list: if isClubAdmin(clubId)
        || isCoach(clubId)
        || isCoachByUserProfile(clubId);
      allow create, update, delete: if false;

      match /seats/{userId} {
        allow get: if (request.auth != null && request.auth.uid == userId)
          || isClubAdmin(clubId)
          || isCoach(clubId)
          || isCoachByUserProfile(clubId);
        allow list: if isClubAdmin(clubId)
          || isCoach(clubId)
          || isCoachByUserProfile(clubId);
        allow create, update, delete: if false;
      }
    }

    // ==============================================================
    // swimmer_overall_summaries
    // Path: /swimmer_overall_summaries/{swimmerId}
    // ==============================================================


    match /support_requests/{id} {
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow get, list: if request.auth != null
        && (
          resource.data.userId == request.auth.uid
          || isStaff()
        );
      allow update: if isStaff();
      allow delete: if false;
    }

    match /invites/{id} {
        allow get, list, create, update: if true;
    }

    match /coach_swimmer_links/{id} {
      allow create, read, update: if true;
    }

    // ==============================================================
    // Entitlements
    // ==============================================================

    match /entitlements/{product} {
      match /plans/{planId} {
        allow read: if true;
        allow create, update, delete: if false;
      }
    }


    // ==============================================================
    // Canonical intensity definitions
    // ==============================================================

    match /intensityDefinitions/{intensityId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false;
    }

    // ==============================================================
    // Admin settings
    // ==============================================================

    match /adminSettings/billing {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
        && request.auth.token.staff == true;
      allow delete: if false;
    }

    // ==============================================================
     // Swim Clubs
     // ==============================================================

     match /swimClubs/{clubId} {

       // ------------------------------------------------------------
       // üèä Club document
       // ------------------------------------------------------------
       allow get: if request.auth != null;
       allow list: if true;                 // Needed for name availability queries
       allow create: if request.auth != null;
       allow update: if isClubAdmin(clubId);

       // ------------------------------------------------------------
       // üëë ADMINS (REQUIRED for bootstrap)
       // ------------------------------------------------------------
       match /admins/{adminId} {
         // Creator bootstraps themselves as admin
         allow create: if request.auth != null
           && request.auth.uid == adminId;

         // Admins can read admins
         allow read: if isClubAdmin(clubId) || (request.auth != null && request.auth.uid == adminId);

         // Roles are immutable
         allow update: if false;

         // Admins can remove admins
         allow delete: if isClubAdmin(clubId);
       }

       // ------------------------------------------------------------
       // üë• COACHES (REQUIRED for bootstrap)
       // ------------------------------------------------------------
       match /coaches/{coachId} {
         function isCoachAssignmentUpdate() {
           return request.resource.data.diff(resource.data)
               .affectedKeys()
               .hasOnly(['assignedGroupIds', 'updatedAt'])
             && (!('assignedGroupIds' in request.resource.data)
               || request.resource.data.assignedGroupIds is list);
         }

         // Coach adds themselves during onboarding
         allow create: if request.auth != null
           && request.auth.uid == coachId;

         allow get: if isCoach(clubId) || isClubAdmin(clubId)
           || (request.auth != null && request.auth.uid == coachId);

         allow list: if isCoach(clubId) || isClubAdmin(clubId)
           || (request.auth != null
             && request.auth.token.email != null
             && request.query.limit <= 1
             && request.query.where('email', '==', request.auth.token.email));

         allow update: if isClubAdmin(clubId) && isCoachAssignmentUpdate();
         allow delete: if false;
       }

       // ------------------------------------------------------------
       // SETTINGS
       // ------------------------------------------------------------
       match /settings/intensity_terminology {
         allow read, write: if isCoach(clubId) || isClubAdmin(clubId);
       }

        match /settings/equipment_terminology {
         allow read, write: if isCoach(clubId) || isClubAdmin(clubId);
       }

       match /settings/stroke_terminology {
         allow read, write: if isCoach(clubId) || isClubAdmin(clubId);
       }

       match /settings/set_type_terminology {
         allow read, write: if isCoach(clubId) || isClubAdmin(clubId);
       }

       // Canonical intensity override docs.
       // Clubs cannot mutate canonical definitions and only override name/description.
       match /intensityOverrides/{intensityId} {
         allow read: if isClubMember(clubId);
         allow create, update: if (isCoach(clubId) || isClubAdmin(clubId))
           && exists(/databases/$(database)/documents/intensityDefinitions/$(intensityId))
           && request.resource.data.keys().hasOnly([
             'clubId',
             'intensityId',
             'customName',
             'customDescription',
             'createdAt',
             'updatedAt'
           ])
           && request.resource.data.clubId == clubId
           && request.resource.data.intensityId == intensityId
           && (
             !('customName' in request.resource.data)
             || request.resource.data.customName is string
             || request.resource.data.customName == null
           )
           && (
             !('customDescription' in request.resource.data)
             || request.resource.data.customDescription is string
             || request.resource.data.customDescription == null
           );
         allow delete: if isCoach(clubId) || isClubAdmin(clubId);
       }

       // ------------------------------------------------------------
       // CYCLES
       // ------------------------------------------------------------
       match /cycles/{eventId} {
         allow read: if true;
         allow create, update, delete: if isCoach(clubId);
       }

       match /loadPlan/{id} {
         allow read: if true;
         allow create, update: if isCoach(clubId);
       }

       match /seasonPlans/{planId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if isCoach(clubId)
           || isCoachByUserProfile(clubId)
           || isClubAdmin(clubId);
       }

       match /weeklyFacilityPlan/{id} {
         allow read: if isClubMember(clubId);
         allow write: if isCoach(clubId);
       }

       match /poolFacilities/{facilityId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if isClubAdmin(clubId);
       }

       match /poolSlotTemplates/{slotTemplateId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if isClubAdmin(clubId);
       }

       match /groupTrainingConfigs/{groupId} {
         allow get, list: if isClubMember(clubId);
         allow create, update: if canManageScheduleGroup(
           clubId,
           request.resource.data.groupId,
           request.resource.data.groupCoachId
         );
         allow delete: if canManageScheduleGroup(
           clubId,
           resource.data.groupId,
           resource.data.groupCoachId
         );
       }

       match /poolRecurringAssignments/{assignmentId} {
         allow get, list: if isClubMember(clubId);
         allow create, update: if canManageScheduleGroup(
           clubId,
           request.resource.data.groupId,
           request.resource.data.groupCoachId
         );
         allow delete: if canManageScheduleGroup(
           clubId,
           resource.data.groupId,
           resource.data.groupCoachId
         );
       }

       match /poolDatedSessions/{sessionId} {
         allow get, list: if isClubMember(clubId);
         allow create, update: if canManageScheduleGroup(
           clubId,
           request.resource.data.groupId,
           request.resource.data.groupCoachId
         );
         allow delete: if canManageScheduleGroup(
           clubId,
           resource.data.groupId,
           resource.data.groupCoachId
         );
       }

       match /groups/{groupId} {
         allow read: if isClubMember(clubId);
         allow create, update, delete: if isCoach(clubId);
       }

       // ------------------------------------------------------------
       // ‚≠ê COACH FAVORITE SETS (workout library)
       // Path: /swimClubs/{clubId}/coachFavoriteSets/{favoriteSetId}
       // ------------------------------------------------------------
       match /coachFavoriteSets/{favoriteSetId} {
         allow get, list: if isCoach(clubId)
           || isCoachByUserProfile(clubId)
           || isClubAdmin(clubId);

         allow create: if (isCoach(clubId) || isCoachByUserProfile(clubId))
           && request.resource.data.clubId == clubId
           && matchesUserIdentity(request.resource.data.coachId);

         allow update, delete: if ((isCoach(clubId)
           || isCoachByUserProfile(clubId))
           && matchesUserIdentity(resource.data.coachId))
           || isClubAdmin(clubId);
       }

       match /swimmerFocusProfile/{profileId} {

         // üëÄ READ SINGLE DOCUMENT
         // Any logged-in user can read
         allow get: if isLoggedIn();

         // üìö READ COLLECTION (queries)
         // Any logged-in user can query
         allow list: if isLoggedIn();

         // ‚úçÔ∏è CREATE
         // Any coach in the club can create
         allow create: if isLoggedIn()
           && isCoach(clubId)
           && request.resource.data.clubId == clubId;

         // üîÅ UPDATE
         // Coach OR the swimmer themselves
         allow update: if isLoggedIn()
           && (
             isCoach(clubId)
             || resource.data.swimmerId == request.auth.uid
           );

         // üóë DELETE
         // Admin or club creator only
         allow delete: if isLoggedIn()
           && (
             isClubAdmin(clubId)
             || isClubCreator(clubId)
           );
       }

       // ------------------------------------------------------------
       // üìÖ PLANNED SESSIONS
       // Path: /swimClubs/{clubId}/sessions/{sessionId}
       // ------------------------------------------------------------
       match /sessions/{sessionId} {
                // Swim Suite portal access is coach/admin-only.
                allow get, list: if isCoach(clubId)
                  || isCoachByUserProfile(clubId)
                  || isClubAdmin(clubId);

                // Coach can create/update/delete
                allow write: if isCoach(clubId);

                // ------------------------------------------------------------
                // ‚úÖ ATTENDANCE CONFIRMATIONS
                // Path: /swimClubs/{clubId}/sessions/{sessionId}/attendanceConfirmations/{swimmerId}
                // ------------------------------------------------------------
                match /attendanceConfirmations/{swimmerId} {
                  // Club members can view attendance confirmations.
                  allow get, list: if isClubMember(clubId);

                  // Coaches/admins can manage all confirmations.
                  allow create, update, delete: if isCoach(clubId)
                    || isCoachByUserProfile(clubId)
                    || isClubAdmin(clubId);
                }
              }

       // ------------------------------------------------------------
       // ‚úÖ SESSION EXECUTIONS (attendance + completion log link)
       // Path: /swimClubs/{clubId}/executions/{executionId}
       // ------------------------------------------------------------
       match /executions/{executionId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if isCoach(clubId);
       }

       // ------------------------------------------------------------
       // üìà TRAINING RESULTS (structured set results)
       // Path: /swimClubs/{clubId}/results/{resultSetId}
       // ------------------------------------------------------------
       match /results/{resultSetId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if isCoach(clubId)
           || isCoachByUserProfile(clubId)
           || isClubAdmin(clubId);
       }

       // ------------------------------------------------------------
       // üìä REPORTING DASHBOARDS (server-side aggregates)
       // ------------------------------------------------------------
       match /reportingDashboards/{docId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if false;
       }

       match /reportingDaily/{dayId} {
         allow get, list: if isClubMember(clubId);
         allow create, update, delete: if false;
       }


       // ------------------------------------------------------------
       // üèä SWIMMERS (club membership)
       // ------------------------------------------------------------
       match /swimmers/{swimmerId} {

         // Coaches & admins can read all swimmers
         allow get, list: if isCoach(clubId) || isClubAdmin(clubId) || isCoachByUserProfile(clubId);

         // Coach creates swimmer
         allow create: if isCoach(clubId)
           && request.resource.data.clubId == clubId;

         // Coach updates swimmer
         allow update: if isCoach(clubId);

         // Optional: allow delete only for admins
         allow delete: if isClubAdmin(clubId);
       }

     }

    // ==============================================================
    // Swim Sets
    // ==============================================================

    match /swimSets/{setId} {

      function isSetOwner() {
        return request.auth != null
          && request.auth.uid == resource.data.createdByCoachId;
      }

      allow read: if true;
      allow create: if true;
      allow update, delete: if isSetOwner();
    }

    // ==============================================================
    // Clubs V2 (Identity/Membership model)
    // ==============================================================

    match /clubs/{clubId} {
      allow get, list: if isV2ClubMember(clubId);
      allow create, update, delete: if false;

      match /members/{uid} {
        function isSelfMembership() {
          return request.auth != null && request.auth.uid == uid;
        }

        function hasValidMemberPayload() {
          return request.resource.data.keys().hasOnly([
              'uid',
              'role',
              'groupId',
              'status',
              'joinedAt',
              'updatedAt'
            ])
            && request.resource.data.uid == uid
            && isValidMembershipRole(request.resource.data.role)
            && isValidMembershipStatus(request.resource.data.status)
            && (!('groupId' in request.resource.data)
              || request.resource.data.groupId == null
              || request.resource.data.groupId is string);
        }

        function isSelfCreate() {
          return isSelfMembership()
            && hasValidMemberPayload()
            && request.resource.data.role == 'swimmer'
            && request.resource.data.status == 'active';
        }

        function isAdminWrite() {
          return isV2ClubAdmin(clubId) && hasValidMemberPayload();
        }

        function isCoachOrAdminGroupAssignment() {
          return isV2ClubCoachOrAdmin(clubId)
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'groupId',
              'updatedAt'
            ])
            && (!('groupId' in request.resource.data)
              || request.resource.data.groupId == null
              || request.resource.data.groupId is string);
        }

        allow get: if isSelfMembership() || isV2ClubCoachOrAdmin(clubId);
        allow list: if isV2ClubCoachOrAdmin(clubId);
        allow create: if isSelfCreate() || isAdminWrite();
        allow update: if isAdminWrite() || isCoachOrAdminGroupAssignment();
        allow delete: if isSelfMembership() || isV2ClubAdmin(clubId);
      }

      match /groups/{groupId} {
        allow get, list: if isV2ClubMember(clubId);
        allow create, update: if isV2ClubAdmin(clubId)
          && request.resource.data.keys().hasOnly(['name', 'coachIds', 'createdAt', 'updatedAt'])
          && request.resource.data.name is string
          && request.resource.data.coachIds is list;
        allow delete: if isV2ClubAdmin(clubId);
      }
    }

    // ==============================================================
    // Users
    // ==============================================================

    match /users/{userId} {
      function isSelf() {
        return request.auth != null && request.auth.uid == userId;
      }

      // Accept both legacy and current app user payload keys.
      function hasAllowedSelfCreateKeys() {
        return request.resource.data.keys().hasOnly([
          'id',
          'name',
          'lastName',
          'email',
          'emailNormalized',
          'photoUrl',
          'profilePicturePath',
          'displayName',
          'photoURL',
          'userType',
          'registerDate',
          'createdAt',
          'updatedAt',
          'roles',
          'role',
          'clubId',
          'creatorId',
          'coachCreatorId',
          'memberOfTeams',
          'ownerOfTeams',
          'isAccountHolder',
          'secondCoachId',
          'thirdCoachId',
          'mainEventIds',
          'primaryStroke',
          'isSwimCoachSupportUser',
          'isSwimAnalyzerProUser',
          'isBetaUser',
          'isReviewer'
        ]);
      }

      function hasSafeSelfCreatePayload() {
        return (!('id' in request.resource.data) || request.resource.data.id == userId)
          && (!('userType' in request.resource.data) || request.resource.data.userType == 'swimmer')
          && !('clubId' in request.resource.data)
          && !('creatorId' in request.resource.data)
          && !('coachCreatorId' in request.resource.data)
          && !('memberOfTeams' in request.resource.data)
          && !('ownerOfTeams' in request.resource.data)
          && !('isAccountHolder' in request.resource.data)
          && !('secondCoachId' in request.resource.data)
          && !('thirdCoachId' in request.resource.data)
          && !('mainEventIds' in request.resource.data)
          && !('primaryStroke' in request.resource.data)
          && (!('roles' in request.resource.data)
            || (request.resource.data.roles is list && request.resource.data.roles.size() == 0))
          && !('role' in request.resource.data)
          && (!('isSwimCoachSupportUser' in request.resource.data)
            || request.resource.data.isSwimCoachSupportUser == false)
          && (!('isSwimAnalyzerProUser' in request.resource.data)
            || request.resource.data.isSwimAnalyzerProUser == false)
          && (!('isBetaUser' in request.resource.data)
            || request.resource.data.isBetaUser == false)
          && (!('isReviewer' in request.resource.data)
            || request.resource.data.isReviewer == false);
      }

      function hasAllowedSelfUpdateKeys() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'id',
          'name',
          'lastName',
          'email',
          'emailNormalized',
          'photoUrl',
          'profilePicturePath',
          'displayName',
          'photoURL',
          'userType',
          'registerDate',
          'createdAt',
          'updatedAt',
          'roles',
          'role',
          'clubId',
          'creatorId',
          'coachCreatorId',
          'memberOfTeams',
          'ownerOfTeams',
          'isAccountHolder',
          'secondCoachId',
          'thirdCoachId',
          'mainEventIds',
          'primaryStroke',
          'isSwimCoachSupportUser',
          'isSwimAnalyzerProUser',
          'isBetaUser',
          'isReviewer'
        ]);
      }

      function protectedFieldsUnchanged() {
        return (!('id' in request.resource.data)
            || request.resource.data.id == userId
            || request.resource.data.id == resource.data.id)
          && (!('userType' in request.resource.data)
            || request.resource.data.userType == resource.data.userType
            || (resource.data.userType == null && request.resource.data.userType == 'swimmer'))
          && (!('clubId' in request.resource.data)
            || request.resource.data.clubId == resource.data.clubId)
          && (!('creatorId' in request.resource.data)
            || request.resource.data.creatorId == resource.data.creatorId)
          && (!('coachCreatorId' in request.resource.data)
            || request.resource.data.coachCreatorId == resource.data.coachCreatorId)
          && (!('memberOfTeams' in request.resource.data)
            || request.resource.data.memberOfTeams == resource.data.memberOfTeams)
          && (!('ownerOfTeams' in request.resource.data)
            || request.resource.data.ownerOfTeams == resource.data.ownerOfTeams)
          && (!('isAccountHolder' in request.resource.data)
            || request.resource.data.isAccountHolder == resource.data.isAccountHolder)
          && (!('secondCoachId' in request.resource.data)
            || request.resource.data.secondCoachId == resource.data.secondCoachId)
          && (!('thirdCoachId' in request.resource.data)
            || request.resource.data.thirdCoachId == resource.data.thirdCoachId)
          && (!('mainEventIds' in request.resource.data)
            || request.resource.data.mainEventIds == resource.data.mainEventIds)
          && (!('primaryStroke' in request.resource.data)
            || request.resource.data.primaryStroke == resource.data.primaryStroke)
          && (!('roles' in request.resource.data)
            || request.resource.data.roles == resource.data.roles)
          && (!('role' in request.resource.data)
            || request.resource.data.role == resource.data.role)
          && (!('isSwimCoachSupportUser' in request.resource.data)
            || request.resource.data.isSwimCoachSupportUser == resource.data.isSwimCoachSupportUser
            || (resource.data.isSwimCoachSupportUser == null
              && request.resource.data.isSwimCoachSupportUser == false))
          && (!('isSwimAnalyzerProUser' in request.resource.data)
            || request.resource.data.isSwimAnalyzerProUser == resource.data.isSwimAnalyzerProUser
            || (resource.data.isSwimAnalyzerProUser == null
              && request.resource.data.isSwimAnalyzerProUser == false))
          && (!('isBetaUser' in request.resource.data)
            || request.resource.data.isBetaUser == resource.data.isBetaUser
            || (resource.data.isBetaUser == null
              && request.resource.data.isBetaUser == false))
          && (!('isReviewer' in request.resource.data)
            || request.resource.data.isReviewer == resource.data.isReviewer
            || (resource.data.isReviewer == null
              && request.resource.data.isReviewer == false));
      }

      allow get: if isSelf();
      allow list: if false;
      allow create: if isSelf()
        && hasAllowedSelfCreateKeys()
        && hasSafeSelfCreatePayload();
      allow update: if isSelf()
        && hasAllowedSelfUpdateKeys()
        && protectedFieldsUnchanged();
      allow delete: if false;
    }

    // ==================================================
    // Completed Swim Sessions
    // Path: /completedSwimSessions/{sessionId}
    // ==================================================
    match /completedSwimSessions/{sessionId} {
      // Coaches can read logs for sessions in their own club.
      allow get: if request.auth != null && (
        isCoachInOwnClub()
        && (
          (resource.data.clubId is string && resource.data.clubId == userClubId())
          || (
            resource.data.swimSessionId is string
            && isSessionInCoachClub(resource.data.swimSessionId)
          )
        )
      );

      // Coaches can list logs for sessions that belong to their club.
      allow list: if request.auth != null && (
        isCoachInOwnClub()
        && resource.data.swimSessionId is string
        && isSessionInCoachClub(resource.data.swimSessionId)
      );

      // Coaches can create logs for swimmers in their club.
      // Prefer clubId scoping when provided; fallback to strict membership checks.
      allow create: if request.auth != null
        && request.resource.data.swimSessionId is string
        && request.resource.data.swimmerId is string
        && isCoachInOwnClub()
        && (
          request.resource.data.clubId == null
          || (
            request.resource.data.clubId is string
            && request.resource.data.clubId == userClubId()
          )
        )
        && (
          (
            request.resource.data.clubId is string
            && request.resource.data.clubId == userClubId()
          )
          || (
            isSessionInCoachClub(request.resource.data.swimSessionId)
            && isSwimmerInCoachClub(request.resource.data.swimmerId)
          )
        );

      allow update, delete: if request.auth != null
        && isCoachInOwnClub()
        && (
          (resource.data.clubId is string && resource.data.clubId == userClubId())
          || (
            resource.data.swimSessionId is string
            && isSessionInCoachClub(resource.data.swimSessionId)
          )
        );
    }
    // END swimify

    // BEGIN swim_analyzer
    match /swimmer_overall_summaries/{swimmerId} {

      function isSelf() {
        return request.auth.uid == swimmerId;
      }

      function isLinkedCoach() {
        return exists(
          /databases/$(database)/documents/coach_swimmer_links/$(request.auth.uid + "_" + swimmerId)
        );
      }

      allow get: if isLoggedIn() && (isSelf() || isLinkedCoach());
      allow list: if false;
      allow create, update, delete: if false;
    }

    // ==============================================================
    // Stripe / Payments
    // ==============================================================

    match /stripe_configs/{id} {
      allow read: if true;
    }

    match /checkout_tokens/{token} {
      allow read, write: if false;
    }

    match /swimAnalyzerSubscriptions/{id} {
      allow read: if request.auth != null
        && (request.auth.uid in resource.data.memberUids
            || request.auth.uid == resource.data.owner);
      allow write: if false;
    }

    // ==============================================================
    // Requests / Invites / Links
    // ==============================================================

    match /analysis_requests/{id} {
      allow create, read, update: if true;
    }
    match /entitlements_swim_analyzer/{planId} {
      allow read: if true;
      allow create, update, delete: if false;
    }
      // ==============================================================
       // Race Analyses
       // Path: /racesAnalyzes/{raceId}
       // ==============================================================

      match /racesAnalyzes/{raceId} {

    // -----------------------------
    // READ (get + list)
    // -----------------------------
    allow read: if true;

    // -----------------------------
    // CREATE
    // -----------------------------
    allow create: if true;

    // -----------------------------
    // UPDATE
    // -----------------------------
    allow update: if true;

    // -----------------------------
    // DELETE
    // -----------------------------
    allow delete: if true;
      }
      match /offTheBlockAnalyzes/{raceId} {

      // -----------------------------
      // READ (get + list)
      // -----------------------------
      allow read: if true;

      // -----------------------------
      // CREATE
      // -----------------------------
      allow create: if true;

      // -----------------------------
      // UPDATE
      // -----------------------------
      allow update: if true;

      // -----------------------------
      // DELETE
      // -----------------------------
      allow delete: if true;
    }
    match /strokeAnalyzes/{raceId} {

      // -----------------------------
      // READ (get + list)
      // -----------------------------
      allow read: if true;

      // -----------------------------
      // CREATE
      // -----------------------------
      allow create: if true;

      // -----------------------------
      // UPDATE
      // -----------------------------
      allow update: if true;

      // -----------------------------
      // DELETE
      // -----------------------------
      allow delete: if true;
    }
    match /strokeAnalyzeGroups/{raceId} {

      // -----------------------------
      // READ (get + list)
      // -----------------------------
      allow read: if true;

      // -----------------------------
      // CREATE
      // -----------------------------
      allow create: if true;

      // -----------------------------
      // UPDATE
      // -----------------------------
      allow update: if true;

      // -----------------------------
      // DELETE
      // -----------------------------
      allow delete: if true;
    }

    match /swimmer_overall_summaries/{docId} {
      allow read: if true;
    }
    // END swim_analyzer

    // BEGIN aquis
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function aquisUserClubId() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.clubId
        : null;
    }

    function isCoachNoteParticipant(note) {
      return isSignedIn() && (
        (note.coachId is string && request.auth.uid == note.coachId) ||
        (note.swimmerId is string && request.auth.uid == note.swimmerId)
      );
    }

    match /users/{uid} {
      allow read: if isSelf(uid);
      allow create, update: if isSelf(uid);
      allow delete: if false;
    }

    match /users/{uid}/health_raw/{dateKey} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    match /users/{uid}/health_derived/{dateKey} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    match /users/{uid}/readiness/{dateKey} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    match /users/{uid}/readiness_overrides/{dateKey} {
      allow read: if isSelf(uid);
      allow write: if false;
    }


    match /dailyTrainingRecords/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.dateKey is string
        && request.resource.data.executedSets is list;
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /attendanceResponses/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow write: if false;
    }

    match /coachNotes/{id} {
      allow read: if isCoachNoteParticipant(resource.data);
      allow write: if false;
    }

    match /aiSubscriptions/{uid} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    match /healthDailyMetrics/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow write: if false;
    }

    match /healthWorkoutMetrics/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow write: if false;
    }

    match /healthSyncState/{uid} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    match /healthCoachDailyAggregates/{id} {
      allow read: if isSignedIn()
        && resource.data.allowedCoachIds is list
        && request.auth.uid in resource.data.allowedCoachIds;
      allow write: if false;
    }

    match /swimClubs/{clubId}/sessions/{sessionId}/attendanceConfirmations/{swimmerId} {
      allow read: if isSignedIn()
        && request.auth.uid == swimmerId;
      allow create, update: if isSignedIn()
        && request.auth.uid == swimmerId
        && request.resource.data.swimmerId == swimmerId
        && request.resource.data.confirmed == true;
      allow delete: if isSignedIn() && request.auth.uid == swimmerId;
    }

    match /swimClubs/{clubId}/swimmerFocusProfile/{profileId} {
      allow read: if isSignedIn()
        && aquisUserClubId() is string
        && aquisUserClubId() == clubId;
      allow write: if false;
    }


    // Completed session logging: exactly one completion per swimmer/session doc id,
    // swimmer can create their own completion, and swimmer/coach can read.
    match /completedSessions/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.swimmerId ||
        (resource.data.coachId is string && request.auth.uid == resource.data.coachId)
      );

      allow create: if isSignedIn()
        && request.resource.data.sessionId is string
        && request.resource.data.swimmerId is string
        && request.resource.data.status in ['asPrescribed', 'adjusted', 'notCompleted']
        && request.resource.data.loggedBy in ['swimmer', 'coach']
        && (
          // Swimmer self-log
          (request.resource.data.loggedBy == 'swimmer' &&
            request.auth.uid == request.resource.data.swimmerId &&
            request.resource.data.tirednessScore is int &&
            request.resource.data.tirednessScore >= 1 &&
            request.resource.data.tirednessScore <= 5) ||
          // Coach-log for swimmer
          (request.resource.data.loggedBy == 'coach' &&
            request.resource.data.coachId is string &&
            request.auth.uid == request.resource.data.coachId)
        );

      allow update, delete: if false;
    }
    // END aquis

  }
}
