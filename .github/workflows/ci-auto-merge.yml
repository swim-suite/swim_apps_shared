name: CI / Test / Auto-Merge + Tag + Release

on:
  push:
    branches:
      - develop
      - feature/**
      - enabler/**
  pull_request:

jobs:
  build:
    name: Validate Build
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.version_bump.outputs.tag }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ---------------------------------------------------------
      # CHECKOUT
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # INSTALL FLUTTER
      # ---------------------------------------------------------
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      # ---------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ---------------------------------------------------------
      - name: Flutter Pub Get
        run: flutter pub get

      # ---------------------------------------------------------
      # ANALYZE + TESTS
      # ---------------------------------------------------------
      # - name: Analyze
      #   run: flutter analyze

      - name: Test
        run: flutter test --no-pub
          
          
          # ---------------------------------------------------------
          # VERSION BUMP (clean x.y.z format)
          # ---------------------------------------------------------
               - name: Bump version in pubspec.yaml
               id: version_bump
               run: |
                 echo "üì¶ Current version:"
                 grep '^version:' pubspec.yaml
                 
                 # Extract version: remove 'version: ' prefix then trim after +
                 RAW_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
                 SEMVER="${RAW_VERSION%%+*}"   # strip +build if it exists
                 
                 echo "Current semver: $SEMVER"
                 
                 # Split semver
                 IFS='.' read -r MAJOR MINOR PATCH <<< "$SEMVER"
                 
                 # Increment patch
                 PATCH=$((PATCH+1))
                 
                 NEW_VERSION="$MAJOR.$MINOR.$PATCH"
                 
                 # Update pubspec.yaml
                 sed -i "s/^version:.*/version: $NEW_VERSION/" pubspec.yaml
                 
                 echo "üîº New version: $NEW_VERSION"
                 echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                 echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # CREATE PR (Action handles commit & push)
      # ---------------------------------------------------------
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "CI: Bump version to ${{ steps.version_bump.outputs.new_version }}"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: ci/version-${{ steps.version_bump.outputs.new_version }}
          delete-branch: true
          title: "CI Auto-Merge: Version ${{ steps.version_bump.outputs.new_version }}"
          body: |
            Automatic version bump and merge into master.
            Version: **${{ steps.version_bump.outputs.new_version }}**
          base: master

      # ---------------------------------------------------------
      # MERGE PR (Force merge immediately)
      # ---------------------------------------------------------
      - name: Merge Pull Request
        if: steps.create_pr.outputs.pull-request-number != ''
        run: |
          gh pr merge ${{ steps.create_pr.outputs.pull-request-number }} --squash --delete-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Tag + Release
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # CONFIGURE GIT
      # ---------------------------------------------------------
      - name: Configure Git
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

      # ---------------------------------------------------------
      # FIND NEXT AVAILABLE TAG
      # ---------------------------------------------------------
      - name: Determine Next Available Tag
        id: next_tag
        run: |
          BASE_TAG="${{ needs.build.outputs.tag }}"

          echo "üîç Searching for next available tag starting from $BASE_TAG"

          TAG="$BASE_TAG"

          # Loop until a free tag is found
          while git ls-remote --tags origin | grep -q "refs/tags/$TAG"; do
            echo "‚ö†Ô∏è Tag $TAG already exists. Incrementing..."

            VERSION="${TAG#v}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            PATCH=$((PATCH + 1))
            TAG="v$MAJOR.$MINOR.$PATCH"
          done

          echo "‚úÖ Using available tag: $TAG"
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
      

      # ---------------------------------------------------------
      # CREATE GIT TAG (guaranteed unique)
      # ---------------------------------------------------------
      - name: Create Tag
        run: |
          TAG="${{ steps.next_tag.outputs.TAG }}"

          echo "üè∑ Creating tag $TAG"
          git tag "$TAG"
          git push origin "$TAG"
      # ---------------------------------------------------------
      # CREATE RELEASE
      # ---------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: "Release ${{ needs.build.outputs.tag }}"
          body: |
            ## SwimSuite Shared Release
            üéâ Version `${{ needs.build.outputs.tag }}` has been published automatically!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
