name: CI / Test / Auto-Merge + Tag + Release

on:
  push:
    branches:
      - develop
      - feature/**
      - enabler/**
  #pull_request:

jobs:
  build:
    name: Validate, Bump & Merge
    runs-on: ubuntu-latest

    # We will compute the tag/version inside the job steps

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ---------------------------------------------------------
      # CHECKOUT
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Required to get the full history for tagging and finding the latest tag
          fetch-depth: 0

      # ---------------------------------------------------------
      # INSTALL GH CLI
      # ---------------------------------------------------------
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      # ---------------------------------------------------------
      # INSTALL FLUTTER
      # ---------------------------------------------------------
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      # ---------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ---------------------------------------------------------
      - name: Flutter Pub Get
        run: flutter pub get

      # ---------------------------------------------------------
      # ANALYZE + TESTS
      # ---------------------------------------------------------
      - name: Test
        run: flutter test --no-pub

      # ---------------------------------------------------------
      # VERSION BUMP (Find latest tag on master for base)
      # ---------------------------------------------------------
      - name: Bump version based on latest tag
        id: version_bump
        run: |
          # 1. Find the latest tag on the target branch (master)
          LATEST_TAG=$(git describe --tags --match "v*.*.*" $(git merge-base HEAD master) --abbrev=0 || echo "v0.0.0")
          
          echo "üì¶ Latest tag on master: $LATEST_TAG"
          
          # 2. Extract and increment the patch version
          SEMVER="${LATEST_TAG#v}" # remove 'v' prefix
          SEMVER_NO_BUILD="${SEMVER%%+*}" # strip +build
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$SEMVER_NO_BUILD"
          
          # Increment patch
          PATCH=$((PATCH+1))
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"
          
          echo "üîº New version: $NEW_VERSION"
          
          # 3. Update pubspec.yaml in the current branch
          sed -i "s/^version:.*/version: $NEW_VERSION/" pubspec.yaml
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # CREATE PR (Action handles commit & push)
      # ---------------------------------------------------------
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          # Use the default GITHUB_TOKEN for internal operations
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "CI: Bump version to ${{ steps.version_bump.outputs.new_version }}"
          branch: ci/version-bump-${{ steps.version_bump.outputs.new_version }}
          delete-branch: true
          title: "CI Auto-Merge: Version ${{ steps.version_bump.outputs.new_version }}"
          body: |
            Automatic version bump and merge into master.
            Version: **${{ steps.version_bump.outputs.new_version }}**
          base: master # Target master branch

      # ---------------------------------------------------------
      # MERGE PR & TAG (CRITICAL: Needs token with 'write' permissions)
      # ---------------------------------------------------------
      - name: Merge PR and Create Tag
        if: steps.create_pr.outputs.pull-request-number != ''
        run: |
          PR_NUMBER=${{ steps.create_pr.outputs.pull-request-number }}
          NEW_TAG=${{ steps.version_bump.outputs.tag }}
          
          # 1. Merge PR using squash to keep history clean
          gh pr merge "$PR_NUMBER" --squash --delete-branch
          
          # 2. Immediately tag the HEAD of the master branch that was just merged
          git fetch origin master
          git checkout master
          
          echo "üè∑ Creating and pushing tag $NEW_TAG"
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Use default token, already has 'contents: write'

      # ---------------------------------------------------------
      # CREATE RELEASE (Runs only if the merge/tag succeeded)
      # ---------------------------------------------------------
      - name: Create GitHub Release
        if: always() # Run even if merge failed, but check for successful tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_bump.outputs.tag }}
          name: "Release ${{ steps.version_bump.outputs.tag }}"
          body: |
            ## Automated Release
            üéâ Version `${{ steps.version_bump.outputs.tag }}` has been published automatically!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}