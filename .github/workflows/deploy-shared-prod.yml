name: Deploy Shared Firebase Infra (PROD)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy"
        required: true
        default: "master"

permissions:
  contents: read
  actions: read

jobs:
  deploy-shared-prod:
    runs-on: ubuntu-latest
    environment: production
    env:
      PROJECT_ID: swim-coach-support
      FIREBASE_TOOLS_VERSION: 13.35.1
      FIREBASE_CLI_EXPERIMENTS: googleAuth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate and compose shared artifacts
        run: python3 firebase_infra/tools/manage_infra.py all

      - name: Authenticate to Google Cloud (PROD)
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Export Google credentials for Firebase
        run: |
          CREDS="${{ steps.gcp-auth.outputs.credentials_file_path }}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$CREDS" >> "$GITHUB_ENV"
          echo "GOOGLE_GHA_CREDS_PATH=$CREDS" >> "$GITHUB_ENV"
          echo "CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=$CREDS" >> "$GITHUB_ENV"
          test -f "$CREDS"

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP auth
        run: |
          gcloud auth list
          gcloud auth print-access-token >/dev/null
          gcloud config set project "$PROJECT_ID"
          gcloud config get-value project

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@$FIREBASE_TOOLS_VERSION --prefer-offline --no-audit

      - name: Verify Firebase auth context
        run: |
          firebase --version
          firebase projects:list --project "$PROJECT_ID" --non-interactive

      - name: Deploy Firestore indexes (PROD)
        run: |
          set +e
          FORCE_OUTPUT="$(firebase deploy \
            --project "$PROJECT_ID" \
            --only firestore:indexes \
            --force \
            --non-interactive 2>&1)"
          FORCE_STATUS=$?
          set -e

          printf '%s\n' "$FORCE_OUTPUT"

          if [ "$FORCE_STATUS" -eq 0 ]; then
            exit 0
          fi

          if printf '%s\n' "$FORCE_OUTPUT" | grep -Fq "HTTP Error: 409, index already exists"; then
            echo "Firestore index sync hit a 409 during --force deploy."
            echo "Falling back to additive deploy so missing indexes are still created."
            firebase deploy \
              --project "$PROJECT_ID" \
              --only firestore:indexes \
              --non-interactive
            exit 0
          fi

          exit "$FORCE_STATUS"

      - name: Deploy Firestore + Storage rules (PROD)
        run: |
          firebase deploy \
            --project "$PROJECT_ID" \
            --only firestore:rules,storage \
            --non-interactive
